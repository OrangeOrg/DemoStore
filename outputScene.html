<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
		<title>场景出图</title>
		<link href="../Build/Cesium/Widgets/widgets.css" rel="stylesheet">
		<link href="./css/pretty.css" rel="stylesheet">
		<link href="./css/bootstrap.min.css" rel="stylesheet">
		<script src="./js/jquery.min.js"></script>

		<script src="./js/bootstrap.min.js"></script>
		<script src="./js/bootstrap-select.min.js"></script>
		<script src="./js/config.js"></script>
		<script type="text/javascript" src="./js/require.min.js" data-main="js/main"></script>
		<style type="text/css">
			.modal-body {
				height: 200px;
			}
			/*.modal{
				width: 300px;
			}*/
		</style>

	</head>

	<body>
		<div id="cesiumContainer"></div>
		<div id='tool' style="position: absolute;left: 5px;top: 5px;">
			<div>
				<input type="button" id="custom" value="场景出图" class="button black" data-toggle="modal" data-target="#myModal">
			</div>
		</div>

		<!-- Modal -->
		<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel">场景出图</h4>
					</div>
					<div class="modal-body">
						<div class="input-group">
							<div class="input-group">
								<span class="input-group-addon" id="basic-addon1">文件名</span>
								<input type="text" class="form-control" id="fileName" placeholder="输入文件名" aria-describedby="basic-addon1">

							</div>
							<select id="fileTypeSelect" class="selectpicker" title="请选择文件类型">
								<option>png</option>
								<option>jpg</option>
							</select>
						</div>

					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
						<button type="button" class="btn btn-primary" id="downloFlie">下载</button>
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript">
			var viewer
			var scene

			function onload(Cesium) {
				viewer = new Cesium.Viewer('cesiumContainer', {
					imageryProvider: new Cesium.BingMapsImageryProvider({
						url: 'https://dev.virtualearth.net',
						mapStyle: Cesium.BingMapsStyle.AERIAL,
						key: URL_CONFIG.BING_MAP_KEY
					})
				});
				scene = viewer.scene;
				var widget = viewer.cesiumWidget;
				try {
					var promise = scene.addS3MTilesLayerByScp(URL_CONFIG.SCP_NIAOCHAO, {
						name: 'niaochao'
					});
					Cesium.when(promise, function(layer) {
						scene.camera.setView({
							destination: new Cesium.Cartesian3.fromDegrees(116.38621009526075, 39.98468016277832, 313.2286367219722),
							orientation: {
								heading: 6.116051,
								pitch: -0.275007,
								roll: 6.283185
							}
						});

					}, function() {
						var title = '加载SCP失败，请检查网络连接状态或者url地址是否正确？';
						widget.showErrorPanel(title, undefined, e);
					});
				} catch(e) {
					if(widget._showRenderLoopErrors) {
						var title = '渲染时发生错误，已停止渲染。';
						widget.showErrorPanel(title, undefined, e);
					}
				}

			}
			$("#downloFlie").on("click", function() {
				var Filebase64Promise = scene.outputSceneToFile();
				Filebase64Promise.then(function(file) {
					var fileName = $('#fileName').val();
					var fileType = $('#fileTypeSelect').selectpicker('val');
					if(fileName && fileType) {
						downloadFile(fileName + '.' + fileType, file);
						$('.close').click();
					} else {
						alert('输入文件名并选择文件类型')
					}

				})
			})

			function base64Img2Blob(code) {
				var parts = code.split(';base64,');
				var contentType = parts[0].split(':')[1];
				var raw = window.atob(parts[1]);
				var rawLength = raw.length;
				var uInt8Array = new Uint8Array(rawLength);
				for(var i = 0; i < rawLength; ++i) {
					uInt8Array[i] = raw.charCodeAt(i);
				}

				return new Blob([uInt8Array], {
					type: contentType
				});
			}

			function downloadFile(fileName, content) {

				var aLink = document.createElement('a');
				var blob = base64Img2Blob(content); //new Blob([content]);

				var evt = document.createEvent("HTMLEvents");
				evt.initEvent("click", false, false); //initEvent 不加后两个参数在FF下会报错
				aLink.download = fileName;
				aLink.href = URL.createObjectURL(blob);

				aLink.dispatchEvent(evt);
				//document.getElementById('tool').appendChild(aLink);
				aLink.click();
			}
		</script>
	</body>

</html>